<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN | Huaraches La 18</title>
    
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://uzpinrjzbucoihxuvdvm.supabase.co">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700;900&display=swap');
        body { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #eab308; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fade-in-down 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-gray-800 min-h-screen text-lg selection:bg-yellow-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, memo } = React;

        const SUPABASE_URL = 'https://uzpinrjzbucoihxuvdvm.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6cGlucmp6YnVjb2loeHV2ZHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNzEyNDgsImV4cCI6MjA3OTc0NzI0OH0.1bIIem8dU3VN-A8AH81smAt584zUD-Yf977MSUIEP2w';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const CONFIG = {
            storeName: "CONTROL DE INVENTARIO",
            assets: { logo: "/navidad.jpg", background: "/catrina1.jpg" } 
        };

        const Icon = memo(({ d, size = 28, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>));
        const Icons = {
            Check: (p) => <Icon {...p} d="M20 6L9 17l-5-5" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />,
            Trash: (p) => <Icon {...p} d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            Plus: (p) => <Icon {...p} d="M12 5v14M5 12h14" />,
        };

        // --- COMPONENTE MODAL PARA AGREGAR ---
        const ProductModal = ({ isOpen, onClose, categories, onSave }) => {
            const [formData, setFormData] = useState({ nombre: '', precio: '', categoria_id: '', quesillo_extra_precio: 0 });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (isOpen && categories.length > 0) {
                    setFormData(prev => ({ ...prev, categoria_id: categories[0].id }));
                }
            }, [isOpen, categories]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                await onSave(formData);
                setIsSaving(false);
                setFormData({ nombre: '', precio: '', categoria_id: categories[0]?.id || '', quesillo_extra_precio: 0 });
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in-down">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl border border-gray-200">
                        <h2 className="text-2xl font-bold mb-4 text-gray-900">Nuevo Producto</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Nombre</label>
                                <input required type="text" className="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-yellow-500 outline-none" value={formData.nombre} onChange={e => setFormData({...formData, nombre: e.target.value})} placeholder="Ej. Huarache Bistec" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Precio</label>
                                    <input required type="number" step="0.50" className="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-yellow-500 outline-none" value={formData.precio} onChange={e => setFormData({...formData, precio: e.target.value})} placeholder="0.00" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Costo Quesillo</label>
                                    <input type="number" step="0.50" className="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-yellow-500 outline-none" value={formData.quesillo_extra_precio} onChange={e => setFormData({...formData, quesillo_extra_precio: e.target.value})} placeholder="0 (Opcional)" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Categoría</label>
                                <select className="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-yellow-500 outline-none" value={formData.categoria_id} onChange={e => setFormData({...formData, categoria_id: e.target.value})}>
                                    {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.nombre}</option>)}
                                </select>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={onClose} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl">Cancelar</button>
                                <button type="submit" disabled={isSaving} className="flex-1 py-3 bg-yellow-500 text-black font-bold rounded-xl shadow-lg hover:bg-yellow-400">
                                    {isSaving ? 'Guardando...' : 'Guardar Producto'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- ITEM ADMINISTRABLE ---
        const AdminProductItem = memo(({ item, onToggle, onDelete }) => {
            // Quitamos el estado local 'isProcessing' para que no parpadee el loader,
            // confiamos en el cambio optimista del padre.
            
            const handleToggle = () => {
                onToggle(item.id, !item.disponible);
            };

            const handleDelete = () => {
                if(confirm(`07Estás seguro de eliminar "${item.nombre}"?`)) {
                    onDelete(item.id);
                }
            };

            return (
                <div className={`relative rounded-2xl shadow-sm border p-4 flex flex-col justify-between items-center transition-all duration-300 ${item.disponible ? 'bg-white border-gray-200' : 'bg-gray-800 border-gray-700 opacity-80'}`}>
                    
                    <button onClick={handleDelete} className="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-50 transition-colors z-10">
                        <Icons.Trash size={20} />
                    </button>

                    <div className="w-full text-center mb-3 mt-4">
                        <h3 className={`font-bold text-lg leading-tight ${item.disponible ? 'text-gray-900' : 'text-gray-400 line-through'}`}>
                            {item.nombre}
                        </h3>
                        <p className={`text-sm ${item.disponible ? 'text-gray-500' : 'text-gray-600'}`}>${item.precio}</p>
                    </div>

                    <button 
                        onClick={handleToggle}
                        className={`
                            relative w-full py-3 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-md active:scale-95
                            ${item.disponible 
                                ? 'bg-green-600 text-white shadow-green-500/30 hover:brightness-110' 
                                : 'bg-red-600 text-white shadow-red-500/30 hover:brightness-110'}
                        `}
                    >
                        {item.disponible ? <><Icons.Check size={20}/> ACTIVO</> : <><Icons.X size={20}/> AGOTADO</>}
                    </button>
                </div>
            );
        });

        // --- APP PRINCIPAL ---
        const App = () => {
            const [categoriesDB, setCategoriesDB] = useState([]);
            const [menuItemsDB, setMenuItemsDB] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [activeCategory, setActiveCategory] = useState("");
            const [notification, setNotification] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            const fetchData = async () => {
                try {
                    const { data: cats, error: errCats } = await supabase.from('categorias').select('*').order('orden', { ascending: true });
                    if (errCats) throw errCats;

                    const { data: items, error: errItems } = await supabase.from('menu_items').select('*');
                    if (errItems) throw errItems;

                    setCategoriesDB(cats);
                    setMenuItemsDB(items);
                    
                    // Solo establecemos la categoría activa la primera vez
                    if (cats.length > 0) {
                        setActiveCategory(prev => prev ? prev : cats[0].nombre);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showNotification("Error de conexión", "error");
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                
                // Suscripción Realtime (Para mantener sincronizados varios dispositivos)
                const channel = supabase
                .channel('realtime_menu_admin')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'menu_items' }, (payload) => {
                     // Solo actualizamos si el cambio viene de OTRO lado, 
                     // para evitar conflictos con nuestro cambio optimista
                     fetchData(); 
                })
                .subscribe();
                return () => { supabase.removeChannel(channel); }
            }, []);

            const showNotification = useCallback((msg, type = "success") => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            }, []);

            // --- CAMBIO DE DISPONIBILIDAD EN TIEMPO REAL (OPTIMISTA) ---
            const toggleAvailability = useCallback(async (id, newStatus) => {
                // 1. Actualizar visualmente DE INMEDIATO (Optimistic UI)
                setMenuItemsDB(prevItems => 
                    prevItems.map(item => item.id === id ? { ...item, disponible: newStatus } : item)
                );

                try {
                    // 2. Enviar a Supabase en segundo plano
                    const { error } = await supabase.from('menu_items').update({ disponible: newStatus }).eq('id', id);
                    if (error) throw error;
                } catch (err) {
                    // 3. Si falla, revertir el cambio visual
                    setMenuItemsDB(prevItems => 
                        prevItems.map(item => item.id === id ? { ...item, disponible: !newStatus } : item)
                    );
                    showNotification("Error al actualizar. Revisa tu conexión.", "error");
                }
            }, []);

            const deleteProduct = useCallback(async (id) => {
                // Optimista
                setMenuItemsDB(prev => prev.filter(item => item.id !== id));
                try {
                    const { error } = await supabase.from('menu_items').delete().eq('id', id);
                    if (error) throw error;
                    showNotification("Producto eliminado");
                } catch (err) {
                    fetchData(); // Revertir recargando
                    showNotification("Error al eliminar", "error");
                }
            }, []);

            const addProduct = useCallback(async (formData) => {
                try {
                    const maxOrder = menuItemsDB.reduce((max, item) => item.orden > max ? item.orden : max, 0);
                    const { error } = await supabase.from('menu_items').insert([{
                        nombre: formData.nombre,
                        precio: parseFloat(formData.precio),
                        categoria_id: parseInt(formData.categoria_id),
                        quesillo_extra_precio: parseFloat(formData.quesillo_extra_precio) || 0,
                        disponible: true,
                        orden: maxOrder + 10
                    }]);

                    if (error) throw error;
                    showNotification("Producto creado exitosamente");
                    fetchData(); // Aquí sí recargamos para obtener el ID nuevo
                } catch (err) {
                    console.error(err);
                    showNotification("Error al crear", "error");
                }
            }, [menuItemsDB]);

            // --- L07GICA DE ORDENAMIENTO (IGUAL QUE LA APP CLIENTE) ---
            const processedMenu = useMemo(() => {
                if (!categoriesDB.length) return [];
                
                return categoriesDB.map(cat => {
                    // 1. Filtrar productos de esta categoría
                    let catItems = menuItemsDB.filter(item => item.categoria_id === cat.id);

                    // 2. Aplicar el mismo ordenamiento complejo que la App Cliente
                    catItems.sort((a, b) => {
                        const nameA = a.nombre.toLowerCase(); 
                        const nameB = b.nombre.toLowerCase();
                        
                        // Lógica Burritos
                        if (cat.nombre === 'Burritos y Costras') {
                            const getWeight = (n) => {
                                if (n.includes('burrito')) return 1; 
                                if (n.includes('costra')) return 2;  
                                return 3; 
                            };
                            return getWeight(nameA) - getWeight(nameB) || a.orden - b.orden;
                        }

                        // Lógica General
                        const getWeight = (n) => { 
                            if (n.includes('sencillo')) return 1; 
                            if (n.includes('quesillo')) return 2; 
                            if (n.includes('huevo')) return 3; 
                            return 10; 
                        };

                        // Lógica Bebidas
                        if (cat.nombre === 'Bebidas') { 
                            const getDrinkWeight = (n) => { 
                                if (n.includes('jamaica')) return 1; 
                                if (n.includes('horchata')) return 2; 
                                if (n.includes('ponche')) return 3; 
                                return 10; 
                            }; 
                            return getDrinkWeight(nameA) - getDrinkWeight(nameB) || a.orden - b.orden; 
                        }

                        const weightA = getWeight(nameA); 
                        const weightB = getWeight(nameB); 
                        
                        if (weightA !== weightB) return weightA - weightB; 
                        return a.orden - b.orden;
                    });

                    return {
                        id: cat.id,
                        category: cat.nombre,
                        items: catItems
                    };
                }).filter(cat => cat.items.length > 0 || true); 
            }, [categoriesDB, menuItemsDB]);

            if (isLoading) return <div className="min-h-screen bg-gray-900 flex items-center justify-center"><div className="loader"></div></div>;

            return (
                <div className="relative min-h-screen bg-black pb-24 text-base">
                    <div className="fixed inset-0 z-0 opacity-20" style={{ backgroundImage: `url(${CONFIG.assets.background})`, backgroundSize: 'cover' }}></div>

                    <header className="bg-gray-900/95 backdrop-blur-md shadow-2xl border-b border-yellow-600 sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <img src={CONFIG.assets.logo} alt="Logo" className="h-10 w-10 rounded-full border border-yellow-500" />
                                <div>
                                    <h1 className="text-lg font-bold text-white leading-none tracking-wide">{CONFIG.storeName}</h1>
                                    <p className="text-yellow-500 text-xs font-mono">PANEL ADMIN</p>
                                </div>
                            </div>
                        </div>
                        <div className="overflow-x-auto no-scrollbar py-3 px-4 flex gap-2 border-t border-gray-800">
                             {processedMenu.map(cat => (
                                <button key={cat.id} onClick={() => setActiveCategory(cat.category)}
                                    className={`whitespace-nowrap px-4 py-1.5 rounded-lg font-bold text-sm transition-colors ${activeCategory === cat.category ? 'bg-yellow-500 text-black' : 'bg-gray-800 text-gray-400 border border-gray-700'}`}>
                                    {cat.category}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 relative z-10">
                        {processedMenu.map(cat => cat.category === activeCategory && (
                            <div key={cat.id} className="animate-fade-in-down min-h-[50vh]">
                                <div className="grid grid-cols-2 gap-3 sm:grid-cols-3">
                                    {cat.items.map((item) => (
                                        <AdminProductItem key={item.id} item={item} onToggle={toggleAvailability} onDelete={deleteProduct} />
                                    ))}
                                </div>
                                {cat.items.length === 0 && <div className="text-gray-500 text-center py-10">Categoría vacía</div>}
                            </div>
                        ))}
                    </main>

                    {/* Botón Flotante para Agregar */}
                    <button onClick={() => setIsModalOpen(true)} className="fixed bottom-6 right-6 bg-yellow-500 text-black p-4 rounded-full shadow-2xl z-50 hover:scale-110 transition-transform active:scale-95">
                        <Icons.Plus size={32} strokeWidth={3} />
                    </button>

                    <ProductModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        categories={categoriesDB} 
                        onSave={addProduct} 
                    />

                    {notification && (
                        <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-2xl z-[100] font-bold border ${notification.type === 'error' ? 'bg-red-900 text-white border-red-500' : 'bg-green-900 text-white border-green-500'}`}>
                            {notification.msg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>